---
variables:
  PROJECT_DIR: One.Settix.RabbitMQ

trigger:
  branches:
    include: [master,beta,preview]
  paths:
    exclude: [CHANGELOG.md]

pool:
  vmImage: ubuntu-22.04

stages:

- stage : DeployStage
  displayName: 'Deploy stage'
  jobs:
  - job: build_pack_publish

    steps:
    - checkout: self
      clean: true
      persistCredentials: true

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '9.x'
        includePreviewVersions: true
    - script: |
        echo "Tag object and the commit it points to:"
        git show-ref --tags -d | grep v3.0.2-rabbitMQ-6.8.1v.1 || true
        echo
        echo "Is that commit reachable from HEAD?"
        TAG_SHA=$(git show-ref --tags -d \
                  | grep v3.0.2-rabbitMQ-6.8.1v.1 \
                  | awk '{print $1}')
        if [ -n "$TAG_SHA" ]; then
          git merge-base --is-ancestor "$TAG_SHA" HEAD \
            && echo "✅ reachable" || echo "❌ NOT reachable"
        fi
      displayName: "Where is the first prerelease tag?"

    - task: DotNetCoreCLI@2
      name: build
      inputs:
        command: build
        projects: 'src/$(PROJECT_DIR)/*.csproj'

    - task: Bash@3
      name: release
      displayName: semantic release + pack
      env:
        STAGING_PATH: $(Build.StagingDirectory)
      inputs:
        targetType: 'inline'
        script: |
          npm install -g semantic-release@22.0.12 @semantic-release/exec@latest @semantic-release/changelog@latest @semantic-release/git@latest
          time npx semantic-release --no-ci
          time npx semantic-release --no-ci
          # few commands for debugging purposes
          ls -l $STAGING_PATH/*.nupkg
          echo dotnet msbuild `dotnet msbuild --version`
          echo dotnet nuget `dotnet nuget --version`
          echo dotnet `dotnet --version`

    - task: NuGetCommand@2
      name: publish
      enabled: true
      condition: and(eq(variables['newVer'], 'yes'), succeeded())
      inputs:
        command: 'push'
        packagesToPush: '$(Build.StagingDirectory)/*.nupkg'
        nuGetFeedType: 'external'
        publishFeedCredentials: 'CI-AzurePipelines'